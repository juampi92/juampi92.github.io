<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">

        <meta property="og:title" content="Reusable Sessions in Laravel - Juampi&#039;s Blog"/>
        <meta name="twitter:title" content="Reusable Sessions in Laravel - Juampi&#039;s Blog">

        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://barreto.jp/blog/reusable-sessions/"/>

        <meta name="description" content="Sessions are an easy-to-use feature for a stateful application, but they usually get messy very quickly. Follow these steps to clean up your Sessions.">
        <meta property="og:description" content="Sessions are an easy-to-use feature for a stateful application, but they usually get messy very quickly. Follow these steps to clean up your Sessions." />

        <meta name="twitter:card" content="article">
                    <meta name="image" content="/assets/images/3-reusable-sessions.jpg" />
            <meta property="og:image" content="/assets/images/3-reusable-sessions.jpg" />
            <meta name="twitter:image" content="/assets/images/3-reusable-sessions.jpg" />
            <meta name="twitter:card" content="summary_large_image"/>
        
        <meta name="twitter:creator" content="@juampi_92"/>

        <title>Reusable Sessions in Laravel | Juampi&#039;s Blog</title>

        <link rel="home" href="https://barreto.jp">

        <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
        <link rel="manifest" href="/favicon/site.webmanifest">

        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Juampi&#039;s Blog Atom Feed">

                    <!-- Global site tag (gtag.js) - Google Analytics -->
            <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKJEWDM5N9"></script>
            <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());

                gtag('config', 'G-FKJEWDM5N9');
            </script>
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
            <link rel="canonical" href="https://barreto.jp/blog/reusable-sessions/" />

        <link rel="stylesheet" href="/assets/build/css/main.css?id=ee59ee3aca5902ac270f2d3c2d3fa7e1">
    </head>

    <body class="flex flex-col justify-between min-h-screen text-gray-800 leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-18 py-4" role="banner">
            <div class="container flex items-center max-w-8xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Juampi&#039;s Blog home" class="inline-flex items-center">
                        <h1 class="text-lg md:text-2xl text-blue-800 font-normal hover:text-blue-600 my-0">Juampi&#039;s Blog</h1>
                    </a>
                </div>

                <div class="flex flex-1 justify-end items-center">
                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Github" href="https://github.com/juampi92" target="_blank"
       class="ml-6 text-gray-700 hover:text-blue-600">
        <svg viewBox="0 0 16 16" class="w-5 h-5" fill="currentColor" aria-hidden="true" width="20" height="20"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
    </a>

    <a title="Twitter" href="https://twitter.com/Juampi_92" target="_blank"
       class="ml-6 text-gray-700 hover:text-blue-600">
        <svg class="w-5 h-5 hover:text-hot-pink" viewBox="0 0 16 16" width="20" height="20"><g transform="matrix(0.6666666666666666,0,0,0.6666666666666666,0,0)"><path d="M23.32,6.44c0.212-0.177,0.241-0.492,0.065-0.704c-0.068-0.082-0.161-0.14-0.265-0.166l-0.79-0.2 c-0.268-0.067-0.431-0.339-0.364-0.606C21.974,4.731,21.986,4.7,22,4.67l0.44-0.89c0.12-0.249,0.015-0.548-0.233-0.668 C22.099,3.06,21.976,3.049,21.86,3.08l-2,0.56c-0.151,0.044-0.314,0.014-0.44-0.08c-0.865-0.649-1.918-1-3-1c-2.761,0-5,2.239-5,5 l0,0v0.36c0.001,0.127-0.094,0.235-0.22,0.25C8.39,8.5,5.7,7.07,2.8,3.73c-0.128-0.142-0.325-0.2-0.51-0.15 C2.124,3.656,2.013,3.817,2,4C1.599,5.645,1.761,7.377,2.46,8.92c0.062,0.123,0.013,0.274-0.11,0.336 C2.303,9.279,2.251,9.288,2.2,9.28L1.08,9.06C0.807,9.016,0.551,9.202,0.507,9.474C0.498,9.533,0.499,9.592,0.51,9.65 c0.175,1.555,1.047,2.945,2.37,3.78c0.124,0.06,0.176,0.21,0.116,0.334c-0.025,0.051-0.065,0.092-0.116,0.116l-0.53,0.21 c-0.256,0.103-0.381,0.394-0.278,0.65c0.005,0.014,0.011,0.027,0.018,0.04c0.595,1.302,1.791,2.229,3.2,2.48 c0.13,0.047,0.197,0.191,0.15,0.32c-0.025,0.07-0.08,0.124-0.15,0.15C3.93,18.292,2.471,18.575,1,18.56 c-0.276-0.055-0.545,0.124-0.6,0.4s0.124,0.545,0.4,0.6l0,0c2.548,1.208,5.321,1.866,8.14,1.93c2.479,0.038,4.915-0.658,7-2 c3.484-2.326,5.571-6.241,5.56-10.43V8.19c0.001-0.147,0.067-0.286,0.18-0.38L23.32,6.44z" stroke="none" fill="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
    </a>
</nav>
                    <button class="flex justify-center items-center bg-blue-500 border border-blue-500 h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="w-auto px-2 pt-6 pb-2 bg-gray-200 shadow hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a title="Github" href="https://github.com/juampi92" target="_blank"
               class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500">
                <svg viewBox="0 0 16 16" class="w-5 h-5" fill="currentColor" aria-hidden="true" width="20" height="20"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            </a>
        </li>
        <li class="pl-4">
            <a title="Twitter" href="https://twitter.com/Juampi_92" target="_blank"
               class="block mt-0 mb-4 text-sm no-underline text-gray-800 hover:text-blue-500">
                <svg class="w-5 h-5 hover:text-hot-pink" viewBox="0 0 16 16" width="20" height="20"><g transform="matrix(0.6666666666666666,0,0,0.6666666666666666,0,0)"><path d="M23.32,6.44c0.212-0.177,0.241-0.492,0.065-0.704c-0.068-0.082-0.161-0.14-0.265-0.166l-0.79-0.2 c-0.268-0.067-0.431-0.339-0.364-0.606C21.974,4.731,21.986,4.7,22,4.67l0.44-0.89c0.12-0.249,0.015-0.548-0.233-0.668 C22.099,3.06,21.976,3.049,21.86,3.08l-2,0.56c-0.151,0.044-0.314,0.014-0.44-0.08c-0.865-0.649-1.918-1-3-1c-2.761,0-5,2.239-5,5 l0,0v0.36c0.001,0.127-0.094,0.235-0.22,0.25C8.39,8.5,5.7,7.07,2.8,3.73c-0.128-0.142-0.325-0.2-0.51-0.15 C2.124,3.656,2.013,3.817,2,4C1.599,5.645,1.761,7.377,2.46,8.92c0.062,0.123,0.013,0.274-0.11,0.336 C2.303,9.279,2.251,9.288,2.2,9.28L1.08,9.06C0.807,9.016,0.551,9.202,0.507,9.474C0.498,9.533,0.499,9.592,0.51,9.65 c0.175,1.555,1.047,2.945,2.37,3.78c0.124,0.06,0.176,0.21,0.116,0.334c-0.025,0.051-0.065,0.092-0.116,0.116l-0.53,0.21 c-0.256,0.103-0.381,0.394-0.278,0.65c0.005,0.014,0.011,0.027,0.018,0.04c0.595,1.302,1.791,2.229,3.2,2.48 c0.13,0.047,0.197,0.191,0.15,0.32c-0.025,0.07-0.08,0.124-0.15,0.15C3.93,18.292,2.471,18.575,1,18.56 c-0.276-0.055-0.545,0.124-0.6,0.4s0.124,0.545,0.4,0.6l0,0c2.548,1.208,5.321,1.866,8.14,1.93c2.479,0.038,4.915-0.658,7-2 c3.484-2.326,5.571-6.241,5.56-10.43V8.19c0.001-0.147,0.067-0.286,0.18-0.38L23.32,6.44z" stroke="none" fill="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
            </a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-8 px-10">
                <h1 class="text-3xl sm:text-5xl font-normal">Reusable Sessions in Laravel</h1>

    <p class="mt-0 mb-12 text-gray-400">December 4, 2022</p>

    
    <div class="border-b border-blue-200 mb-10 pb-3" v-pre>
        <p>Say you need to implement a simple shopping cart feature and you are planning on using the Session for it.</p>

<p>First, you create an endpoint to add a product and an amount:</p>

<pre><code class="language-php">$request-&gt;session()-&gt;push('cart', [
    'productId' =&gt; $product-&gt;id,
    'amount' =&gt; $request-&gt;amount,
]);
</code></pre>

<p>Then, to access it, you create the Cart endpoint to display all items:</p>

<pre><code class="language-php">$items = $request-&gt;session()-&gt;get('cart', []);
</code></pre>

<p>Finally, you allow flushing the session altogether:</p>

<pre><code class="language-php">$request-&gt;session()-&gt;forget('cart');
</code></pre>

<p>This implementation is decent enough, although we repeat <code>'cart'</code> too often. To avoid accidentally introducing a typo, we can refactor it into a constant.</p>

<p>The client sees this and is happy about it. However, after using the feature, they realize they would like to see product recommendations based on what is in the cart.</p>

<p>To achieve this, we simply need to use the <code>RecommendationService</code> that takes an array of product IDs.</p>

<pre><code class="language-php">$items = $request-&gt;session()-&gt;get('cart', []);
$productIds = Arr::pluck($items, 'productId');

$recommendationService-&gt;recommend($productIds);
</code></pre>

<p>This approach doesn't scale. You will have to repeat every section that uses the session. Can you imagine how it would be to update the structure or the way we add products?</p>

<h2>Repository pattern</h2>

<p>This is where the Repository pattern comes into play. They abstract access to the data store and only provide access to business methods.</p>

<p>Let's first imagine the methods we would like to have in this implementation.</p>

<p>A method to add a product.</p>

<pre><code class="language-php">public function addItem(Product $product, int $amount): void;
</code></pre>

<p>A method to get all items.</p>

<pre><code class="language-php">/**
 * @return array&lt;array{productId: int, amount: int}&gt;
 */
public function getItems(): array;
</code></pre>

<p>A method to flush all items.</p>

<pre><code class="language-php">public function flush(): void;
</code></pre>

<p>And finally, a method to retrieve all products.</p>

<pre><code class="language-php">/**
 * @return array&lt;int&gt;
 */
public function getProductIds(): array;
</code></pre>

<p>Perfect!</p>

<p>Now the implementation can write itself:</p>

<pre><code class="language-php">&lt;?php

namespace App\Http\Session;

final class ShoppingCartSession
{
    private const KEY = 'cart';

    public function __construct(
        private readonly Store $store,
    ) {}

    public function addProduct(Product $product, int $amount): void
    {
        $this-&gt;store-&gt;push(self::KEY, [
            'productId' =&gt; $product-&gt;id,
            'amount' =&gt; $amount,
        ]);
    }

    /**
     * @return array&lt;array{productId: int, amount: int}&gt;
     */
    public function getItems(): array
    {
        return $this-&gt;store-&gt;get(self::KEY, []);
    }

    /**
     * @return array&lt;int&gt;
     */
    public function getProductIds(): array
    {
        return Arr::pluck($this-&gt;getItems(), 'productId');
    }

    public function flush(): void
    {
        return $this-&gt;store-&gt;forget(self::KEY);
    }
}
</code></pre>

<p>And the controller would look something like this:</p>

<pre><code class="language-php">public function store(Request $request, Product $product, ShoppingCartSession $cart)
{
    $cart-&gt;addProduct($product, $request-&gt;amount);
    // ...
</code></pre>

<hr />

<p>Some key features of using a class are:</p>

<ul>
<li>The dependencies are injected. There is no need to worry about facades or requests.</li>
<li>You expose the methods that will be used by the controllers. As a consequence, you hide the underlying implementation, preventing invalid data from being inserted.</li>
<li>You never expose the key.</li>
</ul>

<p>Even though in this example we store the same array-shape structure as we read, we could easily use a ValueObject, and refactor the getItems method to return an array of ProductItem value object instead.</p>

<p>Now, where to locate these classes? I personally suggest <code>app/Http/Session</code>. Although they are a storage, the Session is an http-dependent storage (you can’t access the session inside a Command, for instance).</p>

<p><u>Bonus track</u>: As a next level exercise, I would like to advise to take a look at this <a href="https://gist.github.com/juampi92/487dd66c5b2507679dd4c76863e6c01c" target="_blank">KeyedSession implementation</a> to avoid repeating the key every time.</p>
    </div>

    <div class="border-blue-200 mb-10 pb-4 pt-1 text-center">
        <p>
            Have you found this helpful?
            <br> Follow me on <a title="Twitter" href="https://twitter.com/Juampi_92" target="_blank">
                <svg class="w-4 h-4 inline" viewBox="0 0 16 16" width="16" height="16"><g transform="matrix(0.6666666666666666,0,0,0.6666666666666666,0,0)"><path d="M23.32,6.44c0.212-0.177,0.241-0.492,0.065-0.704c-0.068-0.082-0.161-0.14-0.265-0.166l-0.79-0.2 c-0.268-0.067-0.431-0.339-0.364-0.606C21.974,4.731,21.986,4.7,22,4.67l0.44-0.89c0.12-0.249,0.015-0.548-0.233-0.668 C22.099,3.06,21.976,3.049,21.86,3.08l-2,0.56c-0.151,0.044-0.314,0.014-0.44-0.08c-0.865-0.649-1.918-1-3-1c-2.761,0-5,2.239-5,5 l0,0v0.36c0.001,0.127-0.094,0.235-0.22,0.25C8.39,8.5,5.7,7.07,2.8,3.73c-0.128-0.142-0.325-0.2-0.51-0.15 C2.124,3.656,2.013,3.817,2,4C1.599,5.645,1.761,7.377,2.46,8.92c0.062,0.123,0.013,0.274-0.11,0.336 C2.303,9.279,2.251,9.288,2.2,9.28L1.08,9.06C0.807,9.016,0.551,9.202,0.507,9.474C0.498,9.533,0.499,9.592,0.51,9.65 c0.175,1.555,1.047,2.945,2.37,3.78c0.124,0.06,0.176,0.21,0.116,0.334c-0.025,0.051-0.065,0.092-0.116,0.116l-0.53,0.21 c-0.256,0.103-0.381,0.394-0.278,0.65c0.005,0.014,0.011,0.027,0.018,0.04c0.595,1.302,1.791,2.229,3.2,2.48 c0.13,0.047,0.197,0.191,0.15,0.32c-0.025,0.07-0.08,0.124-0.15,0.15C3.93,18.292,2.471,18.575,1,18.56 c-0.276-0.055-0.545,0.124-0.6,0.4s0.124,0.545,0.4,0.6l0,0c2.548,1.208,5.321,1.866,8.14,1.93c2.479,0.038,4.915-0.658,7-2 c3.484-2.326,5.571-6.241,5.56-10.43V8.19c0.001-0.147,0.067-0.286,0.18-0.38L23.32,6.44z" stroke="none" fill="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
            </a> for more.
        </p>
    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://barreto.jp/blog/interviewing-conflict/" title="Older Post: Interviewing Conflict">
                    &LeftArrow; Interviewing Conflict
                </a>
                    </div>

        <div>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-6 py-4 border-t-2 border-t-gray-300" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-none">
                <li class="md:mr-2">
                    &copy; Juan Pablo Barreto 2022.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>;
                    hosted by <a href="https://pages.github.com/">GitHub Pages</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=3295b1a6dd31b6ce4b507f59d0564985"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
